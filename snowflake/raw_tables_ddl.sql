USE WAREHOUSE COMPUTE_WH;
USE DATABASE EPC_DB;
USE SCHEMA RAW;

CREATE OR REPLACE TABLE COPY_AUDIT (
    FILEPATH               STRING,             -- full S3 path (s3://...)
    TARGET_TABLE           STRING,             -- destination table name
    STATUS                 STRING,             -- LOADED / PARTIALLY_LOADED / SKIPPED
    ROWS_PARSED            NUMBER,             -- total rows parsed
    ROWS_LOADED            NUMBER,             -- successfully loaded
    ERROR_LIMIT            NUMBER,             -- maximum allowed errors
    ERRORS_SEEN            NUMBER,             -- number of errors during load
    FIRST_ERROR            STRING,             -- first error message, if any
    FIRST_ERROR_LINE       NUMBER,             -- line number of first error
    FIRST_ERROR_CHARACTER  NUMBER,             -- character position of first error
    FIRST_ERROR_COLUMN_NAME STRING,            -- column with first error
    STAGED_FILE_SIZE       NUMBER,             -- file size in bytes
    LOAD_TS                TIMESTAMP_LTZ DEFAULT CURRENT_TIMESTAMP,
    DAG_RUN_ID             STRING              -- Airflow DAG run identifier
);

CREATE OR REPLACE TABLE DISPLAY_CERTIFICATES (
    LMK_KEY STRING,
    ADDRESS1 STRING,
    ADDRESS2 STRING,
    ADDRESS3 STRING,
    POSTCODE STRING,
    BUILDING_REFERENCE_NUMBER STRING,
    CURRENT_OPERATIONAL_RATING FLOAT,
    YR1_OPERATIONAL_RATING FLOAT,
    YR2_OPERATIONAL_RATING FLOAT,
    OPERATIONAL_RATING_BAND STRING,
    ELECTRIC_CO2 FLOAT,
    HEATING_CO2 FLOAT,
    RENEWABLES_CO2 FLOAT,
    PROPERTY_TYPE STRING,
    INSPECTION_DATE DATE,
    LOCAL_AUTHORITY STRING,
    CONSTITUENCY STRING,
    COUNTY STRING,
    LODGEMENT_DATE DATE,
    MAIN_BENCHMARK STRING,
    MAIN_HEATING_FUEL STRING,
    OTHER_FUEL STRING,
    SPECIAL_ENERGY_USES STRING,
    RENEWABLE_SOURCES STRING,
    TOTAL_FLOOR_AREA INTEGER,
    ANNUAL_THERMAL_FUEL_USAGE INTEGER,
    TYPICAL_THERMAL_FUEL_USAGE INTEGER,
    ANNUAL_ELECTRICAL_FUEL_USAGE INTEGER,
    TYPICAL_ELECTRICAL_FUEL_USAGE INTEGER,
    RENEWABLES_FUEL_THERMAL INTEGER,
    RENEWABLES_ELECTRICAL FLOAT,
    YR1_ELECTRICITY_CO2 FLOAT,
    YR2_ELECTRICITY_CO2 FLOAT,
    YR1_HEATING_CO2 FLOAT,
    YR2_HEATING_CO2 FLOAT,
    YR1_RENEWABLES_CO2 FLOAT,
    YR2_RENEWABLES_CO2 FLOAT,
    AIRCON_PRESENT STRING,
    AIRCON_KW_RATING FLOAT,
    ESTIMATED_AIRCON_KW_RATING FLOAT,
    AC_INSPECTION_COMMISSIONED FLOAT,
    BUILDING_ENVIRONMENT STRING,
    BUILDING_CATEGORY STRING,
    ADDRESS STRING,
    LOCAL_AUTHORITY_LABEL STRING,
    CONSTITUENCY_LABEL STRING,
    POSTTOWN STRING,
    NOMINATED_DATE DATE,
    OR_ASSESSMENT_END_DATE DATE,
    LODGEMENT_DATETIME TIMESTAMP_LTZ,
    OCCUPANCY_LEVEL STRING,
    UPRN INTEGER,
    UPRN_SOURCE STRING,
    REPORT_TYPE INTEGER
);

CREATE OR REPLACE TABLE DISPLAY_RECOMMENDATIONS (
    PAYBACK_TYPE STRING NOT NULL,
    LMK_KEY STRING NOT NULL,
    RECOMMENDATION_ITEM INTEGER,
    RECOMMENDATION_CODE STRING,
    RECOMMENDATION STRING,
    CO2_IMPACT STRING,
    PRIMARY KEY (LMK_KEY),
    FOREIGN KEY (LMK_KEY) REFERENCES DISPLAY_CERTIFICATES(LMK_KEY)
);

CREATE OR REPLACE TABLE NON_DOMESTIC_CERTIFICATES (
  LMK_KEY STRING NOT NULL,
  ADDRESS1 STRING,
  ADDRESS2 STRING,
  ADDRESS3 STRING,
  POSTCODE STRING,
  BUILDING_REFERENCE_NUMBER STRING,
  ASSET_RATING INTEGER,
  ASSET_RATING_BAND STRING,
  PROPERTY_TYPE STRING,
  INSPECTION_DATE TIMESTAMP_LTZ,
  LOCAL_AUTHORITY STRING,
  CONSTITUENCY STRING,
  COUNTY STRING,
  LODGEMENT_DATE TIMESTAMP_LTZ,
  TRANSACTION_TYPE STRING,
  NEW_BUILD_BENCHMARK STRING,
  EXISTING_STOCK_BENCHMARK STRING,
  BUILDING_LEVEL STRING,
  MAIN_HEATING_FUEL STRING,
  OTHER_FUEL_DESC STRING,
  SPECIAL_ENERGY_USES STRING,
  RENEWABLE_SOURCES STRING,
  FLOOR_AREA INTEGER,
  STANDARD_EMISSIONS FLOAT,
  TARGET_EMISSIONS FLOAT,
  TYPICAL_EMISSIONS FLOAT,
  BUILDING_EMISSIONS FLOAT,
  AIRCON_PRESENT STRING,
  AIRCON_KW_RATING FLOAT,
  ESTIMATED_AIRCON_KW_RATING FLOAT,
  AC_INSPECTION_COMMISSIONED INTEGER,
  BUILDING_ENVIRONMENT STRING,
  ADDRESS STRING,
  LOCAL_AUTHORITY_LABEL STRING,
  CONSTITUENCY_LABEL STRING,
  POSTTOWN STRING,
  LODGEMENT_DATETIME TIMESTAMP_LTZ,
  PRIMARY_ENERGY_VALUE INTEGER,
  UPRN INTEGER,
  UPRN_SOURCE STRING,
  REPORT_TYPE INTEGER,
  PRIMARY KEY (LMK_KEY)
);

CREATE OR REPLACE TABLE NON_DOMESTIC_RECOMMENDATIONS (
  PAYBACK_TYPE STRING,
  LMK_KEY STRING NOT NULL,
  RECOMMENDATION_ITEM INTEGER,
  RECOMMENDATION_CODE STRING,
  RECOMMENDATION STRING,
  CO2_IMPACT STRING,
  PRIMARY KEY (LMK_KEY),
  FOREIGN KEY (LMK_KEY) REFERENCES NON_DOMESTIC_CERTIFICATES(LMK_KEY)
);

CREATE OR REPLACE TABLE DOMESTIC_CERTIFICATES (
  LMK_KEY STRING NOT NULL,
  ADDRESS1 STRING,
  ADDRESS2 STRING,
  ADDRESS3 STRING,
  POSTCODE STRING,
  BUILDING_REFERENCE_NUMBER STRING,
  CURRENT_ENERGY_RATING STRING,
  POTENTIAL_ENERGY_RATING STRING,
  CURRENT_ENERGY_EFFICIENCY INTEGER,
  POTENTIAL_ENERGY_EFFICIENCY INTEGER,
  PROPERTY_TYPE STRING,
  BUILT_FORM STRING,
  INSPECTION_DATE DATE,
  LOCAL_AUTHORITY STRING,
  CONSTITUENCY STRING,
  COUNTY STRING,
  LODGEMENT_DATE DATE,
  TRANSACTION_TYPE STRING,
  ENVIRONMENTAL_IMPACT_CURRENT INTEGER,
  ENVIRONMENTAL_IMPACT_POTENTIAL INTEGER,
  ENERGY_CONSUMPTION_CURRENT FLOAT,
  ENERGY_CONSUMPTION_POTENTIAL FLOAT,
  CO2_EMISSIONS_CURRENT FLOAT,
  CO2_EMISS_CURR_PER_FLOOR_AREA FLOAT,
  CO2_EMISSIONS_POTENTIAL FLOAT,
  LIGHTING_COST_CURRENT FLOAT,
  LIGHTING_COST_POTENTIAL FLOAT,
  HEATING_COST_CURRENT FLOAT,
  HEATING_COST_POTENTIAL FLOAT,
  HOT_WATER_COST_CURRENT FLOAT,
  HOT_WATER_COST_POTENTIAL FLOAT,
  TOTAL_FLOOR_AREA FLOAT,
  ENERGY_TARIFF STRING,
  MAINS_GAS_FLAG STRING,
  FLOOR_LEVEL STRING,
  FLAT_TOP_STOREY STRING,
  FLAT_STOREY_COUNT FLOAT,
  MAIN_HEATING_CONTROLS STRING,
  MULTI_GLAZE_PROPORTION FLOAT,
  GLAZED_TYPE STRING,
  GLAZED_AREA STRING,
  EXTENSION_COUNT INTEGER,
  NUMBER_HABITABLE_ROOMS FLOAT,
  NUMBER_HEATED_ROOMS FLOAT,
  LOW_ENERGY_LIGHTING INTEGER,
  NUMBER_OPEN_FIREPLACES INTEGER,
  HOTWATER_DESCRIPTION STRING,
  HOT_WATER_ENERGY_EFF STRING,
  HOT_WATER_ENV_EFF STRING,
  FLOOR_DESCRIPTION STRING,
  FLOOR_ENERGY_EFF STRING,
  FLOOR_ENV_EFF STRING,
  WINDOWS_DESCRIPTION STRING,
  WINDOWS_ENERGY_EFF STRING,
  WINDOWS_ENV_EFF STRING,
  WALLS_DESCRIPTION STRING,
  WALLS_ENERGY_EFF STRING,
  WALLS_ENV_EFF STRING,
  SECONDHEAT_DESCRIPTION STRING,
  SHEATING_ENERGY_EFF STRING,
  SHEATING_ENV_EFF STRING,
  ROOF_DESCRIPTION STRING,
  ROOF_ENERGY_EFF STRING,
  ROOF_ENV_EFF STRING,
  MAINHEAT_DESCRIPTION STRING,
  MAINHEAT_ENERGY_EFF STRING,
  MAINHEAT_ENV_EFF STRING,
  MAINHEATCONT_DESCRIPTION STRING,
  MAINHEATC_ENERGY_EFF STRING,
  MAINHEATC_ENV_EFF STRING,
  LIGHTING_DESCRIPTION STRING,
  LIGHTING_ENERGY_EFF STRING,
  LIGHTING_ENV_EFF STRING,
  MAIN_FUEL STRING,
  WIND_TURBINE_COUNT FLOAT,
  HEAT_LOSS_CORRIDOR STRING,
  UNHEATED_CORRIDOR_LENGTH FLOAT,
  FLOOR_HEIGHT FLOAT,
  PHOTO_SUPPLY FLOAT,
  SOLAR_WATER_HEATING_FLAG STRING,
  MECHANICAL_VENTILATION STRING,
  ADDRESS STRING,
  LOCAL_AUTHORITY_LABEL STRING,
  CONSTITUENCY_LABEL STRING,
  POSTTOWN STRING,
  CONSTRUCTION_AGE_BAND STRING,
  LODGEMENT_DATETIME TIMESTAMP_LTZ,
  TENURE STRING,
  FIXED_LIGHTING_OUTLETS_COUNT FLOAT,
  LOW_ENERGY_FIXED_LIGHT_COUNT FLOAT,
  UPRN INTEGER,
  UPRN_SOURCE STRING,
  REPORT_TYPE INTEGER,
  PRIMARY KEY (LMK_KEY)
);

CREATE TABLE DOMESTIC_RECOMMENDATIONS (
    LMK_KEY STRING NOT NULL,
    IMPROVEMENT_ITEM INTEGER,
    IMPROVEMENT_SUMMARY_TEXT STRING,
    IMPROVEMENT_DESCR_TEXT STRING,
    IMPROVEMENT_ID INTEGER,
    IMPROVEMENT_ID_TEXT STRING,
    INDICATIVE_COST STRING,
    PRIMARY KEY (LMK_KEY),
    FOREIGN KEY (LMK_KEY) REFERENCES DOMESTIC_CERTIFICATES(LMK_KEY)
);